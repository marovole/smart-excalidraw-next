# 内置 GLM-4.6 功能测试指南

## 环境配置

### 1. 设置环境变量
在部署环境中设置以下环境变量：

```bash
export BUILTIN_GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
export BUILTIN_GLM_API_KEY=your_actual_api_key
export BUILTIN_GLM_MODEL=glm-4.6
```

### 2. 验证配置
访问 `/api/builtin-llm-meta` 端点验证配置是否正确：

```bash
curl http://localhost:3000/api/builtin-llm-meta
```

期望返回：
```json
{
  "provider": "glm-4.6",
  "status": "ready",
  "model": "glm-4.6",
  "lastChecked": "2024-01-01T00:00:00.000Z",
  "rateLimit": {
    "requestsPerMinute": 60,
    "tokensPerMinute": 30000,
    "currentUsage": {
      "requests": 0,
      "tokens": 0
    }
  },
  "meta": {
    "version": "1.0.0",
    "description": "内置 GLM-4.6 智能助手",
    "features": ["text-generation", "streaming"]
  }
}
```

## 功能测试

### 测试场景 1：首次用户开箱即用
**目标**: 验证无配置用户自动使用内置 GLM

**步骤**:
1. 清除浏览器 localStorage
2. 访问应用
3. 检查是否自动显示"GLM-4.6 (内置)"状态
4. 尝试生成图表

**预期结果**:
- 页面自动加载内置配置
- 状态显示蓝色，标识为"GLM-4.6 (内置)"
- 能够正常生成图表内容

### 测试场景 2：配置优先级
**目标**: 验证用户自定义配置优先于内置配置

**步骤**:
1. 配置一个自定义 OpenAI API
2. 确认切换到自定义配置
3. 刷新页面
4. 检查是否保持自定义配置

**预期结果**:
- 状态显示绿色，标识为自定义配置名称
- 刷新后仍使用自定义配置
- 内置配置作为后备选项

### 测试场景 3：配置切换
**目标**: 验证内置和自定义配置之间的切换

**步骤**:
1. 从自定义配置切换到内置 GLM
2. 从内置 GLM 切换回自定义配置
3. 验证切换后生成功能正常

**预期结果**:
- 切换过程流畅，状态指示正确
- 每次切换后都能正常生成内容
- 配置状态正确保存

### 测试场景 4：使用量监控
**目标**: 验证内置 GLM 的使用量监控功能

**步骤**:
1. 使用内置 GLM 生成多个图表
2. 检查配置管理中的使用量统计
3. 达到限制时验证限制功能

**预期结果**:
- 请求次数和 token 消耗正确记录
- 达到限制时显示友好提示
- 引导用户配置自定义 API

### 测试场景 5：错误处理
**目标**: 验证内置 GLM 不可用时的降级机制

**步骤**:
1. 临时设置无效的 API 密钥
2. 访问应用
3. 检查错误提示和降级行为

**预期结果**:
- 显示友好的错误信息
- 引导用户配置自定义 API
- 不影响其他功能使用

## 错误排查

### 常见问题

1. **内置 GLM 未启用**
   - 检查环境变量是否正确设置
   - 验证 API 密钥是否有效

2. **生成失败**
   - 检查网络连接
   - 验证 API 配额是否充足
   - 查看浏览器控制台错误日志

3. **状态显示异常**
   - 清除浏览器缓存重新加载
   - 检查 localStorage 是否正常工作

### 调试工具

1. **浏览器控制台**: 查看客户端错误
2. **网络面板**: 检查 API 请求状态
3. **环境变量**: 验证服务端配置

## 性能考虑

1. **响应时间**: 内置 GLM 可能比自定义 API 稍慢
2. **并发限制**: 注意 GLM API 的并发限制
3. **缓存策略**: 元数据接口有 30 秒缓存

## 安全检查

1. **API 密钥保护**: 确保密钥不暴露给客户端
2. **HTTPS 传输**: 生产环境必须使用 HTTPS
3. **访问控制**: 考虑添加额外的访问限制

## 部署注意事项

1. **环境变量**: 在生产环境正确设置所有必需的环境变量
2. **监控**: 添加 API 调用监控和日志记录
3. **备份**: 准备降级方案，在内置服务不可用时引导用户使用自定义配置